<div class="flex-1 flex flex-col w-full max-w-5xl mx-auto p-4">

  <!-- ════════════════════════════════════════════ -->
  <!-- LIST VIEW                                    -->
  <!-- ════════════════════════════════════════════ -->
  <ng-container *ngIf="viewMode === 'list'">

    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex-1 flex flex-col">

      <!-- Table Header Bar -->
      <div class="bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-800/80 px-4 py-3 flex justify-between items-center border-b border-slate-200 dark:border-slate-700">
        <h2 class="text-sm font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 uppercase tracking-wider">
          <span class="material-symbols-outlined text-primary">list_alt</span>
          Lista de Contactos
        </h2>
        <button (click)="showNewForm()"
          class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-800 transition-all shadow-md active:scale-95">
          <span class="material-symbols-outlined text-[18px]">add</span>
          Nuevo +
        </button>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto flex-1">
        <table class="w-full text-left text-sm border-collapse">
          <thead>
            <tr class="bg-slate-50 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400 font-semibold border-b border-slate-200 dark:border-slate-700">
              <th class="px-4 py-3">Tipo</th>
              <th class="px-4 py-3">Teléfono</th>
              <th class="px-4 py-3">Nombre</th>
              <th class="px-4 py-3 text-center">Principal</th>
              <th class="px-4 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
            <tr *ngFor="let contact of contacts"
              class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
              <!-- Notification Type Icons -->
              <td class="px-4 py-3">
                <div class="flex gap-1">
                  <span *ngFor="let n of getNotifIcons(contact)"
                    [class]="'material-symbols-outlined text-[20px] ' + n.color"
                    [title]="n.title">{{ n.icon }}</span>
                  <span *ngIf="getNotifIcons(contact).length === 0" class="text-slate-300 text-xs">—</span>
                </div>
              </td>
              <!-- Phone -->
              <td class="px-4 py-3 font-medium text-slate-800 dark:text-white">{{ contact.telefono }}</td>
              <!-- Name -->
              <td class="px-4 py-3 text-slate-700 dark:text-slate-300">{{ contact.nombre }} {{ contact.apellido }}</td>
              <!-- Primary Star -->
              <td class="px-4 py-3 text-center">
                <span class="material-symbols-outlined"
                  [ngClass]="contact.esEmergencia ? 'text-primary filled-icon' : 'text-slate-300 dark:text-slate-600'">star</span>
              </td>
              <!-- Actions -->
              <td class="px-4 py-3 text-right">
                <button (click)="showEditForm(contact)"
                  class="p-1 text-slate-400 hover:text-primary transition-colors">
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <button (click)="deleteContact(contact)"
                  class="p-1 text-slate-400 hover:text-red-600 transition-colors">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </td>
            </tr>

            <!-- Empty state -->
            <tr *ngIf="contacts.length === 0">
              <td colspan="5" class="px-4 py-12 text-center text-slate-400 dark:text-slate-500">
                <span class="material-symbols-outlined text-4xl block mb-2">person_off</span>
                No hay contactos registrados
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </ng-container>

  <!-- ════════════════════════════════════════════ -->
  <!-- FORM VIEW (Add / Edit)                       -->
  <!-- ════════════════════════════════════════════ -->
  <ng-container *ngIf="viewMode === 'form'">

    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex-1 flex flex-col">

      <!-- Form Header -->
      <div class="bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-800/80 px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center gap-3">
        <button (click)="backToList()"
          class="flex items-center justify-center size-9 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
          <span class="material-symbols-outlined text-xl">arrow_back</span>
        </button>
        <h2 class="text-sm font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 uppercase tracking-wider">
          <span class="material-symbols-outlined text-primary">person_add</span>
          {{ isNew ? 'Nuevo Contacto' : 'Editar Contacto' }}
        </h2>
      </div>

      <!-- Form Body -->
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-y-auto">

        <!-- Nombre -->
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Nombre *</label>
          <input [(ngModel)]="formData.nombre" type="text" placeholder="Ej: Juan"
            class="w-full border-slate-300 dark:border-slate-600 rounded-lg focus:ring-primary focus:border-primary text-sm bg-slate-50 dark:bg-slate-900 dark:text-white" />
        </div>

        <!-- Apellido -->
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Apellido</label>
          <input [(ngModel)]="formData.apellido" type="text" placeholder="Ej: Pérez"
            class="w-full border-slate-300 dark:border-slate-600 rounded-lg focus:ring-primary focus:border-primary text-sm bg-slate-50 dark:bg-slate-900 dark:text-white" />
        </div>

        <!-- Teléfono -->
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Teléfono *</label>
          <input [(ngModel)]="formData.telefono" type="tel" placeholder="+54 11 0000 0000"
            class="w-full border-slate-300 dark:border-slate-600 rounded-lg focus:ring-primary focus:border-primary text-sm bg-slate-50 dark:bg-slate-900 dark:text-white" />
        </div>

        <!-- Email -->
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Email</label>
          <input [(ngModel)]="formData.email" type="email" placeholder="ejemplo@correo.com"
            class="w-full border-slate-300 dark:border-slate-600 rounded-lg focus:ring-primary focus:border-primary text-sm bg-slate-50 dark:bg-slate-900 dark:text-white" />
        </div>

        <!-- Relación -->
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Relación</label>
          <select [(ngModel)]="formData.relacion"
            class="w-full border-slate-300 dark:border-slate-600 rounded-lg focus:ring-primary focus:border-primary text-sm bg-slate-50 dark:bg-slate-900 dark:text-white">
            <option *ngFor="let rel of relationOptions" [value]="rel">{{ rel }}</option>
          </select>
        </div>

        <!-- Notification Types -->
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Tipo de Notificación</label>
          <div class="flex items-center gap-2">
            <button *ngFor="let nt of notificationTypes"
              (click)="toggleNotif(nt)"
              [ngClass]="isNotifActive(nt)
                ? 'border-2 border-primary bg-primary/5 dark:bg-primary/10 text-primary'
                : 'border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-400 hover:border-primary/50'"
              class="flex-1 flex flex-col items-center p-2 rounded-lg transition-colors cursor-pointer">
              <span class="material-symbols-outlined">{{ notificationIcons[nt.id] }}</span>
              <span class="text-[10px] font-bold mt-1">{{ nt.descripcion }}</span>
            </button>
          </div>
        </div>

        <!-- Emergency checkbox -->
        <div class="md:col-span-2 pt-2 flex items-center gap-3 bg-primary/5 dark:bg-primary/10 p-4 rounded-lg border border-primary/20">
          <input [(ngModel)]="formData.esEmergencia" type="checkbox" id="check-emergency"
            class="w-5 h-5 text-primary rounded border-slate-300 dark:border-slate-600 focus:ring-primary" />
          <label for="check-emergency"
            class="text-sm font-semibold text-primary flex items-center gap-2 cursor-pointer">
            <span class="material-symbols-outlined">star</span>
            Marcar como contacto de emergencia principal
          </label>
        </div>
      </div>
    </section>

    <!-- Footer Actions -->
    <div class="shrink-0 pt-4 pb-2">
      <div class="grid grid-cols-3 gap-3">
        <button (click)="backToList()"
          class="flex w-full cursor-pointer items-center justify-center rounded-lg h-12 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm font-bold transition-colors shadow-sm active:bg-slate-100 dark:active:bg-slate-600">
          <span class="truncate">Cancelar</span>
        </button>
        <button (click)="resetForm()"
          class="flex w-full cursor-pointer items-center justify-center rounded-lg h-12 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm font-bold transition-colors shadow-sm active:bg-slate-100 dark:active:bg-slate-600">
          <span class="truncate">Restablecer</span>
        </button>
        <button (click)="saveContact()" [disabled]="loading"
          class="flex w-full cursor-pointer items-center justify-center rounded-lg h-12 bg-primary border border-transparent hover:bg-primary-dark text-white text-sm font-bold transition-colors shadow-sm active:bg-[#0f172a] disabled:opacity-50">
          <span *ngIf="!loading" class="truncate">Guardar</span>
          <span *ngIf="loading" class="flex items-center gap-2">
            <span class="animate-spin material-symbols-outlined text-base">sync</span> Guardando...
          </span>
        </button>
      </div>
    </div>

  </ng-container>

</div>
